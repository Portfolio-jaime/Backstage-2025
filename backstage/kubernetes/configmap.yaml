# ConfigMap con configuración de Backstage para Kubernetes
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config
  namespace: backstage
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: backend
data:
  app-config.yaml: |
    app:
      title: Backstage Platform
      baseUrl: http://backstage.test.com
      
    organization:
      name: Mi Organización

    backend:
      baseUrl: http://backstage.test.com
      listen:
        port: 7007
        host: 0.0.0.0
      
      cors:
        origin: http://backstage.test.com
        methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
        credentials: true
      
      database:
        client: pg
        connection:
          host: postgres
          port: 5432
          user: backstage
          password: ${POSTGRES_PASSWORD}
          database: backstage
          ssl: false
      
      cache:
        store: redis
        connection: redis://redis:6379

    # Integrations temporarily disabled to avoid GitHub token issues
    integrations: {}

    argocd:
      username: ${ARGOCD_USERNAME}
      password: ${ARGOCD_PASSWORD}
      appLocatorMethods:
        - type: 'config'
          instances:
            - name: default
              url: ${ARGOCD_URL}
              username: ${ARGOCD_USERNAME}
              password: ${ARGOCD_PASSWORD}

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: local
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              skipMetricsLookup: false

    auth:
      environment: production
      session:
        secret: ${AUTH_SECRET}
      
      providers:
        guest: {}

    catalog:
      readonly: false
      rules:
        - allow: [Component, System, API, Resource, Location, User, Group, Domain]
      
      locations:
        - type: file
          target: /app/catalog/entities/all.yaml
          rules:
            - allow: [User, Group]
        - type: file
          target: /app/catalog/systems/systems.yaml
          rules:
            - allow: [System, Component, Resource]

    techdocs:
      builder: 'local'
      generator:
        runIn: 'local'
      publisher:
        type: 'local'

    proxy:
      '/argocd/api':
        target: ${ARGOCD_URL}/api
        changeOrigin: true
        secure: false
        headers:
          Authorization: Basic ${ARGOCD_AUTH_TOKEN}